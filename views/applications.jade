extends layout

block scripts
    script(type='text/javascript').
        function validateNewApplication() {
            var appid = $('#appid').val();
            var appname = $('#appname').val();

            var appidError = '';
            var appnameError = '';
            if (!appid)
                appidError = 'Please enter a value for the application ID.';
            if (!appname)
                appnameError = 'Please enter a value for the application name.';

            try {
                $('#errorAppid').text(appidError);
                $('#errorAppname').text(appnameError);
            } catch (err) {
                alert('Validation errored! Check your input values.');
                return;
            }
            
            var somethingBad = !!appidError
                || !!appnameError;

            if (!somethingBad) {
                $('#submit_new').prop("disabled", true);
                $.post('/applications/check-app', {
                    app_id: appid
                }, function (data, status) {
                    $('#submit_new').prop("disabled", false);
                    if (!data.valid) {
                        $('#errorAppid').text(data.message);
                    } else {
                        $('#new_app_form').submit();
                    }
                });
            }
        }


block content
    .jumbotron.wicked-application-title
        .container.wicked-title-container
            h1 Register and View Your Applications

            p= glob.views.applications.titleTagline

    .container.wicked-container

        p.
            An application is the entity to which you attach your API subscriptions. You can own or co-own applications with other developers. Once you have registered an application, you can create and assign APIs that use it. You can assign only one application to an API.

        if !authUser
            .panel.panel-danger
                .panel-heading
                    h4.panel-title Not logged in
                .panel-body
                    p You are not logged in. Applications can only be created if you are logged in.

                    a(href="/login?redirect=/applications").btn.btn-default Log in &raquo;
                    | &nbsp;&nbsp;
                    a(href="/signup").btn.btn-default Sign up &raquo;

        else
            .panel-group
                div(class='panel panel-default')
                    .panel-heading
                        +panelTitle('Register a new Application', '/help/applications', '#collapse')
                    div(id='collapse' class='panel-collapse collapse #{showRegister}')
                        .panel-body
                            form(role='form' id='new_app_form' action='/applications/register' method='POST')
                                .form-group
                                    label(for='appid') Application ID:
                                    input(type='string' id='appid' name='appid').form-control
                                    small Application IDs must be all lower case, and may only contain the following characters: a-z, 0-9, -, _
                                    small 
                                        span(id='errorAppid' style='color:red')
                                .form-group
                                    label(for='appname') Application Name:
                                    input(type='string' id='appname' name='appname').form-control
                                    small A human readable description/name of the your application, e.g. 'My Awesome Application'
                                    small 
                                        span(id='errorAppname' style='color:red')

                                .checkbox
                                    label
                                        input(type='checkbox' name='hasredirecturi' data-toggle='collapse' data-target='#redirecturipanel')
                                        strong This application will use OAuth2.0 Flows
                                        | &nbsp;(other than the Client Credentials flow, i.e. using redirects)

                                div(id='redirecturipanel' class='panel-collapse collapse')
                                    .form-group
                                        label(for='redirecturi') Redirect URI:
                                        input(type='string' id='redirecturi' name='redirecturi' value='https://').form-control
                                        small.
                                            The callback under which your web application can be called back, passing the access token in the fragment.
                                            <b>Must be an <code>https://</code> URI</b>, except for testing purposes, for which also <code>http://localhost</code> is accepted.
                                        small 
                                            span(id='errorRedirecturi' style='color:red')
                            // Note that this button is _outside_ of the form, and calls submit() over jQuery
                            // in Javascript. It validates the data partly over an Ajax call.
                            p
                                button(id='submit_new' onclick='javascript:validateNewApplication()').btn.btn-success Register Application

            hr

            if applications.length == 0
                br
                h4 You don't have any registered applications
            else
                p To review owners, view API keys for this application or to unregister an application, please click the application name.

                table.table.table-striped
                    thead
                        tr
                            th ID
                            th Name
                            th Role
                    tbody
                        each app, i in applications
                            tr
                                td= app.id
                                td
                                    a(href='/applications/#{app.id}')= app.name
                                td= app.userRole
